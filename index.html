<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Generador de Horario Universitario</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        :root {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --accent-color: #4a4a4a;
            --border-color: #333;
            --input-bg: #2c2c2c;
        }

        body {
            background-color: var(--bg-color);
            color: var(--text-color);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            box-sizing: border-box;
        }

        /* Contenedores ajustados al contenido */
        .step-container {
            background-color: var(--container-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.5);
            width: fit-content;
            max-width: 95vw;
            margin: auto;
            display: none; /* Ocultos por defecto */
            border: 1px solid var(--border-color);
            position: relative;
            box-sizing: border-box;
        }

        .step-container.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        h2, h3 {
            margin-top: 0;
            border-bottom: 1px solid var(--accent-color);
            padding-bottom: 10px;
            text-align: center;
        }

        .form-group {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        label {
            margin-bottom: 5px;
            font-size: 0.9rem;
            color: #bbb;
        }

        input[type="text"],
        input[type="number"],
        select {
            background-color: var(--input-bg);
            border: 1px solid var(--border-color);
            color: white;
            padding: 8px;
            border-radius: 4px;
            outline: none;
            font-size: 16px; /* Evita zoom en iOS */
            width: 100%;
            max-width: 250px;
            box-sizing: border-box;
        }

        input:focus, select:focus {
            border-color: #888;
        }

        /* Quitar flechas de input number */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
        input[type=number] {
            -moz-appearance: textfield;
        }

        /* Botones */
        .btn {
            background-color: #333;
            color: white;
            border: 1px solid #555;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px;
            font-size: 1rem;
            margin-top: 10px;
            width: 100%;
            transition: background 0.3s;
        }

        .btn:hover {
            background-color: #555;
        }

        /* Checkboxes de días */
        .days-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
        }

        .day-option {
            background: var(--input-bg);
            padding: 10px;
            border-radius: 4px;
            text-align: center;
            cursor: pointer;
            border: 1px solid var(--border-color);
        }

        .day-option.selected {
            background-color: #fff;
            color: #000;
            font-weight: bold;
        }

        .day-option input {
            display: none;
        }

        /* Materias dinámicas */
        .subject-row {
            border-top: 1px solid #333;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .subject-inputs {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .subject-inputs .form-group {
            width: auto;
        }

        .subject-inputs input {
            width: 100px;
        }

        .sub-start, .sub-end {
            cursor: pointer;
        }

        /* Reloj Android Style Modal */
        #clock-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .clock-container {
            background: #2a2a2a;
            padding: 20px;
            border-radius: 10px;
            width: 300px;
            text-align: center;
            box-shadow: 0 0 20px rgba(0,0,0,0.8);
        }

        .clock-face {
            width: 200px;
            height: 200px;
            background: #333;
            border-radius: 50%;
            margin: 20px auto;
            position: relative;
        }

        .clock-number {
            position: absolute;
            width: 30px;
            height: 30px;
            line-height: 30px;
            text-align: center;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            color: #fff;
        }

        .clock-number:hover, .clock-number.selected {
            background-color: #009688; /* Android tealish */
            color: white;
        }

        .clock-display {
            font-size: 2.5rem;
            margin-bottom: 10px;
            font-family: monospace;
        }

        .clock-display span {
            cursor: pointer;
            padding: 5px;
        }
        
        .clock-display span.active {
            color: #009688;
        }
        
        .am-pm-toggle {
            font-size: 1rem;
            margin-left: 10px;
            display: inline-block;
            vertical-align: middle;
        }
        .am-pm-toggle span {
            display: block;
            cursor: pointer;
            color: #777;
        }

        #schedule-to-print {
            width: fit-content;
            margin: 0 auto;
        }

        /* Tabla de Horario */
        #schedule-result {
            background: white; /* Para el PDF se ve mejor en blanco/gris claro o mantenemos oscuro */
            background-color: #f0f0f0;
            color: #000;
            padding: 20px;
            width: fit-content;
            box-sizing: border-box;
        }

        .schedule-header {
            display: flex;
            border-bottom: 2px solid #000;
        }

        .time-col-header {
            width: 60px;
            flex-shrink: 0;
            border-right: 1px solid #ccc;
            box-sizing: border-box;
        }

        .day-col-header {
            flex-grow: 0;
            text-align: center;
            font-weight: bold;
            border-right: 1px solid #ccc;
            padding: 5px;
            background: #ddd;
            width: 130px;
            box-sizing: border-box;
        }

        .schedule-body {
            position: relative;
            /* La altura se define dinámicamente en JS */
            background: repeating-linear-gradient(
                to bottom,
                #fff 0px,
                #fff 44px,
                #ccc 45px
            );
            display: flex;
        }

        .time-labels {
            width: 60px;
            flex-shrink: 0;
            border-right: 2px solid #000;
            position: relative;
            background: #e0e0e0;
            box-sizing: border-box;
        }

        .time-label {
            position: absolute;
            width: 100%;
            text-align: right;
            padding-right: 5px;
            font-size: 0.7rem;
            border-top: 1px solid #999;
            box-sizing: border-box;
        }

        .day-column {
            flex-grow: 0;
            position: relative;
            border-right: 1px solid #ccc;
            width: 130px;
            box-sizing: border-box;
        }

        .class-block {
            position: absolute;
            background-color: #555;
            color: white;
            width: 90%;
            left: 5%;
            border-radius: 4px;
            font-size: 0.6rem;
            padding: 2px;
            box-sizing: border-box;
            overflow: hidden;
            border: 1px solid #000;
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            text-align: center;
            line-height: 1;
            word-break: break-word;
            transition: height 0.2s, z-index 0.2s;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Mensaje de error de fecha */
        #date-error {
            color: #ff6b6b;
            text-align: center;
            font-size: 1.2rem;
            display: none;
        }

        /* Estilos para la lista de horarios y tarjetas */
        .schedule-card {
            background: #2c2c2c;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 15px;
            position: relative;
            border: 1px solid #444;
            cursor: pointer;
            transition: background 0.3s;
            display: flex;
            flex-direction: column;
        }
        .schedule-card:hover {
            background: #383838;
        }
        .schedule-info {
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            flex-wrap: wrap;
            gap: 10px;
        }
        .schedule-info h3 {
            margin: 0;
            padding-bottom: 0;
            border-bottom: none;
            text-align: left;
            font-size: 1rem;
            color: #e0e0e0;
        }
        .schedule-info p {
            margin: 0;
            color: #e0e0e0;
            font-size: 1rem;
        }
        .card-options-container {
            display: none;
            flex-direction: row;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #444;
            width: 100%;
            animation: fadeIn 0.3s;
        }
        .card-options-container.active {
            display: flex;
        }
        .card-options-container .btn {
            margin: 0;
            width: auto;
            flex: 1;
            max-width: 150px;
        }

        .back-arrow {
            position: absolute;
            top: 15px;
            left: 15px;
            background: transparent;
            border: none;
            color: #aaa;
            font-size: 1.5rem;
            cursor: pointer;
            padding: 0;
            width: auto;
            margin: 0;
        }
        .back-arrow:hover {
            color: #fff;
        }

        /* Responsividad Móvil */
        @media (max-width: 600px) {
            body {
                padding: 10px;
            }
            .step-container {
                width: 100%;
                padding: 15px;
            }
            .subject-inputs {
                justify-content: space-between;
            }
            .subject-inputs .form-group {
                width: 48%;
            }
            .subject-inputs input {
                width: 100%;
            }
            .schedule-info {
                justify-content: flex-start;
                gap: 15px;
            }
        }
    </style>
</head>
<body>

    <!-- Mensaje de Bloqueo por Fecha -->
    <div id="date-error" class="step-container">
        <h2>Sistema Cerrado</h2>
        <p>La creación de horarios solo está disponible de Julio a Agosto y de Diciembre a Febrero.</p>
    </div>

    <!-- Modal de Bienvenida (Sesión Activa) -->
    <div id="welcome-modal" class="step-container" style="text-align: center;">
        <h2>Bienvenido</h2>
        <p id="welcome-msg" style="font-size: 1.1rem; margin: 20px 0;"></p>
        <button class="btn" id="btn-view-schedules" onclick="showSchedulesList()">Ver horarios</button>
        <button class="btn" id="btn-create-schedule" onclick="startRegistration()">Crear horario</button>
        <button class="btn" onclick="updateSession()">Actualizar datos del estudiante</button>
        <button class="btn" style="background: transparent; border: none; color: #aaa; margin-top: 10px;" onclick="logout()">Cerrar Sesión</button>
    </div>

    <!-- Lista de Horarios -->
    <div id="schedules-list-page" class="step-container">
        <button class="back-arrow" onclick="backToSession()">&#8592;</button>
        <h2 style="margin-top: 10px;">Mis Horarios</h2>
        <div id="schedules-list-container"></div>
    </div>

    <!-- Landing Page -->
    <div id="landing-page" class="step-container">
        <h2>Bienvenido</h2>
        <p style="text-align:center; margin-bottom: 20px;">¿Qué desea hacer?</p>
        <button class="btn" onclick="showLogin('view')">Ingresar</button>
        <button class="btn" onclick="startRegistration()">Crear horario</button>
        <button class="btn" onclick="showLogin('update')">Actualizar datos del estudiante</button>
    </div>

    <!-- Login Page -->
    <div id="login-page" class="step-container">
        <button class="back-arrow" onclick="showLanding()">&#8592;</button>
        <h2>Ingresar</h2>
        <div class="form-group">
            <label>Nombre Completo</label>
            <input type="text" id="login-name">
        </div>
        <div class="form-group">
            <label>Instituto</label>
            <input type="text" id="login-institute">
        </div>
        <div class="form-group">
            <label>Carrera</label>
            <input type="text" id="login-career">
        </div>
        <button class="btn" id="login-btn" onclick="attemptLogin()">Ver mi Horario</button>
    </div>

    <!-- Paso 1: Datos Estudiante -->
    <div id="step-1" class="step-container">
        <button class="back-arrow" onclick="showLanding()">&#8592;</button>
        <h2>Datos del Estudiante</h2>
        <div class="form-group">
            <label>Nombre Completo</label>
            <input type="text" id="student-name">
        </div>
        <div class="form-group">
            <label>Tipo de Instituto</label>
            <select id="institute-type">
                <option value="" disabled selected hidden>Tipo de institucion</option>
                <option value="Universidad">Universidad</option>
                <option value="Coorporacion">Coorporacion</option>
                <option value="Politecnico">Politecnico</option>
            </select>
        </div>
        <div class="form-group">
            <label>Instituto</label>
            <input type="text" id="student-institute">
        </div>
        <div class="form-group">
            <label>Carrera</label>
            <input type="text" id="student-career">
        </div>
        <button class="btn" onclick="goToStep(2)">Registrar datos académicos</button>
    </div>

    <!-- Paso 2: Semestre -->
    <div id="step-2" class="step-container">
        <button class="back-arrow" onclick="step2Back()">&#8592;</button>
        <h2>Información Académica</h2>
        <div class="form-group">
            <label>Semestre a cursar</label>
            <input type="number" id="semester-num" min="1" max="10" oninput="validateSemester(this)">
        </div>
        <div class="form-group">
            <label>Periodo del año</label>
            <select id="semester-year">
                <!-- Se llena con JS -->
            </select>
        </div>
        <button class="btn" onclick="goToStep(3)">Siguiente</button>
    </div>

    <!-- Paso 3: Selección de Días -->
    <div id="step-3" class="step-container">
        <button class="back-arrow" onclick="step3Back()">&#8592;</button>
        <h2>Días de Estudio</h2>
        <p style="font-size: 0.9rem; color: #aaa; text-align: center;">Selecciona los días que asistirás</p>
        <div class="days-grid">
            <label class="day-option"><input type="checkbox" value="Lunes" onchange="toggleDayStyle(this)"> Lunes</label>
            <label class="day-option"><input type="checkbox" value="Martes" onchange="toggleDayStyle(this)"> Martes</label>
            <label class="day-option"><input type="checkbox" value="Miércoles" onchange="toggleDayStyle(this)"> Miércoles</label>
            <label class="day-option"><input type="checkbox" value="Jueves" onchange="toggleDayStyle(this)"> Jueves</label>
            <label class="day-option"><input type="checkbox" value="Viernes" onchange="toggleDayStyle(this)"> Viernes</label>
            <label class="day-option"><input type="checkbox" value="Sábado" onchange="toggleDayStyle(this)"> Sábado</label>
            <label class="day-option"><input type="checkbox" value="Domingo" onchange="toggleDayStyle(this)"> Domingo</label>
        </div>
        <button class="btn" onclick="prepareSubjects()">Aceptar</button>
    </div>

    <!-- Paso 4: Materias por Día -->
    <div id="step-4" class="step-container">
        <button class="back-arrow" onclick="goToStep(3)">&#8592;</button>
        <h2>Detalle de Materias</h2>
        <div id="subjects-container">
            <!-- Se generan inputs aquí -->
        </div>
        <button class="btn" id="generate-btn" style="display:none;" onclick="generateSchedule()">Guardar y Generar Horario</button>
    </div>

    <!-- Paso 5: Resultado -->
    <div id="step-5" class="step-container" style="max-width: 95vw;">
        <button class="back-arrow" onclick="showSchedulesList()">&#8592;</button>
        <h2 style="margin-top: 10px;">Horario Generado</h2>
        <div style="overflow-x: auto; width: 100%; border: 1px solid #333; margin-bottom: 15px; box-sizing: border-box;">
            <div id="schedule-to-print">
                <div style="padding: 10px; background: #ddd; color: #000; margin-bottom: 10px;">
                    <h3 style="margin:0; border:none;" id="res-student"></h3>
                    <p style="margin:5px 0;" id="res-details"></p>
                </div>
                <div id="schedule-result">
                    <!-- Tabla gráfica -->
                </div>
            </div>
        </div>
        <button class="btn" onclick="downloadPDF()">Descargar PDF</button>
        <button class="btn" onclick="downloadPNG()">Descargar Imagen (PNG)</button>
        <button class="btn" id="btn-finish" onclick="finishSchedule()">Finalizar</button>
    </div>

    <!-- Modal Reloj -->
    <div id="clock-modal">
        <div class="clock-container">
            <div class="clock-display">
                <span id="clock-h" class="active" onclick="switchClockMode('h')">--</span>:<span id="clock-m" onclick="switchClockMode('m')">--</span>
                <div class="am-pm-toggle">
                    <span id="btn-am" onclick="setAmPm('AM')">AM</span>
                    <span id="btn-pm" onclick="setAmPm('PM')">PM</span>
                </div>
            </div>
            <div class="clock-face" id="clock-face">
                <!-- Números generados por JS -->
            </div>
            <button class="btn" id="clock-ok-btn" style="display:none;" onclick="confirmTime()">Aceptar</button>
            <button class="btn" style="background: transparent; border: none; color: #aaa; margin-top: 5px;" onclick="closeClock()">Cancelar</button>
        </div>
    </div>

    <script>
        // --- Lógica de Fechas (Julio-Agosto, Diciembre-Febrero) ---
        let isDateAllowed = false;

        function checkAvailability() {
            const now = new Date();
            const month = now.getMonth(); // 0 = Enero, 11 = Diciembre
            
            // Julio (6), Agosto (7), Diciembre (11), Enero (0), Febrero (1)
            const allowedMonths = [6, 7, 11, 0, 1];
            
            if (allowedMonths.includes(month)) {
                isDateAllowed = true;
                const session = localStorage.getItem('current_session');
                if (session) {
                    try {
                        showWelcomeModal(JSON.parse(session));
                    } catch(e) {
                        showLanding();
                    }
                } else {
                    showLanding();
                }
                initYearSelect();
            } else {
                document.getElementById('date-error').classList.add('active');
                document.getElementById('date-error').style.display = 'block';
            }
        }

        function initYearSelect() {
            const year = new Date().getFullYear();
            const select = document.getElementById('semester-year');
            const opt1 = document.createElement('option');
            opt1.value = `${year}-01`;
            opt1.text = `${year}-01`;
            const opt2 = document.createElement('option');
            opt2.value = `${year}-02`;
            opt2.text = `${year}-02`;
            select.add(opt1);
            select.add(opt2);
        }

        function showWelcomeModal(data) {
            hideAllSteps();
            const modal = document.getElementById('welcome-modal');
            const msg = document.getElementById('welcome-msg');
            
            let article = 'de la';
            if (data.instituteType === 'Politecnico') {
                article = 'del';
            }
            
            msg.innerText = `Bienvenido ${data.studentName} ${article} ${data.institute}`;
            
            // Lógica del botón "Crear horario"
            const btnCreate = document.getElementById('btn-create-schedule');
            const hasSchedule = data.schedule && Object.keys(data.schedule).length > 0;
            
            if (isDateAllowed && !hasSchedule) {
                btnCreate.style.display = 'block';
            } else {
                btnCreate.style.display = 'none';
            }

            modal.style.display = 'block';
            setTimeout(() => modal.classList.add('active'), 10);
        }

        function backToSession() {
            const session = localStorage.getItem('current_session');
            if(session) showWelcomeModal(JSON.parse(session));
            else showLanding();
        }

        function showSchedulesList() {
            hideAllSteps();
            const container = document.getElementById('schedules-list-container');
            container.innerHTML = '';
            
            const session = JSON.parse(localStorage.getItem('current_session'));
            
            if (session && session.schedule && Object.keys(session.schedule).length > 0) {
                // Calcular total de materias
                let totalSubjects = 0;
                Object.values(session.schedule).forEach(arr => totalSubjects += arr.length);
                
                const card = document.createElement('div');
                card.className = 'schedule-card';
                card.onclick = (e) => toggleCardOptions(e, card);
                
                card.innerHTML = `
                    <div class="schedule-info">
                        <h3>Semestre ${session.semesterNum}</h3>
                        <p><strong>Materias:</strong> ${totalSubjects}</p>
                        <p><strong>Días:</strong> ${session.days.join(', ')}</p>
                    </div>
                    <div class="card-options-container">
                        <button class="btn" onclick="viewScheduleFromList(event)">Ver</button>
                        <button class="btn" onclick="editSchedule(event)">Editar</button>
                        <button class="btn" style="background-color:#d32f2f;" onclick="deleteSchedule(event)">Eliminar</button>
                    </div>
                `;
                container.appendChild(card);
            } else {
                container.innerHTML = '<p style="text-align:center; color:#aaa;">No tienes horarios creados.</p>';
            }

            const page = document.getElementById('schedules-list-page');
            page.style.display = 'block';
            setTimeout(() => page.classList.add('active'), 10);
        }

        function toggleCardOptions(e, card) {
            // Prevenir que se cierre si clickeamos botones
            if(e.target.tagName === 'BUTTON') return;
            
            const overlay = card.querySelector('.card-options-container');
            const isActive = overlay.classList.contains('active');
            
            // Cerrar otros
            document.querySelectorAll('.card-options-container').forEach(el => el.classList.remove('active'));
            
            if(!isActive) overlay.classList.add('active');
        }

        function viewScheduleFromList(e) {
            e.stopPropagation();
            const session = JSON.parse(localStorage.getItem('current_session'));
            renderScheduleFromData(session, 'view');
        }

        function deleteSchedule(e) {
            e.stopPropagation();
            if(!confirm("¿Estás seguro de eliminar este horario?")) return;
            
            const session = JSON.parse(localStorage.getItem('current_session'));
            delete session.schedule;
            delete session.days;
            
            // Actualizar LocalStorage y Session
            saveToLocal(session);
            localStorage.setItem('current_session', JSON.stringify(session));
            
            showSchedulesList(); // Recargar lista
        }

        function editSchedule(e) {
            e.stopPropagation();
            isEditing = true;
            const session = JSON.parse(localStorage.getItem('current_session'));
            
            // 1. Poblar datos ocultos (Step 1 y 2)
            document.getElementById('student-name').value = session.studentName;
            document.getElementById('institute-type').value = session.instituteType;
            document.getElementById('student-institute').value = session.institute;
            document.getElementById('student-career').value = session.career;
            document.getElementById('semester-num').value = session.semesterNum;
            document.getElementById('semester-year').value = session.semesterYear;

            // 2. Preparar Step 3 (Checkboxes)
            document.querySelectorAll('#step-3 input[type="checkbox"]').forEach(cb => {
                cb.checked = session.days.includes(cb.value);
                toggleDayStyle(cb);
            });

            // 3. Ir al paso 3 (Días) para permitir agregar/quitar
            goToStep(3);
        }

        function updateSession() {
            const session = JSON.parse(localStorage.getItem('current_session'));
            if(session) {
                document.getElementById('student-name').value = session.studentName;
                document.getElementById('institute-type').value = session.instituteType;
                document.getElementById('student-institute').value = session.institute;
                document.getElementById('student-career').value = session.career;
                document.getElementById('semester-num').value = session.semesterNum;
                document.getElementById('semester-year').value = session.semesterYear;
                goToStep(1);
            }
        }

        function logout() {
            // Borramos la sesión para que al recargar no entre automáticamente
            localStorage.removeItem('current_session');
            showLanding();
        }

        // --- Funciones de Inicio y Login ---
        const STORAGE_KEY = 'university_schedules_db';
        let isEditing = false;
        let loginAction = 'view';

        function showLanding() {
            hideAllSteps();
            const el = document.getElementById('landing-page');
            el.style.display = 'block';
            setTimeout(() => el.classList.add('active'), 10);
        }

        function startRegistration() {
            isEditing = false;
            const session = JSON.parse(localStorage.getItem('current_session') || 'null');
            
            if (session) {
                // Si hay sesión, precargamos datos del estudiante y vamos al paso 2
                document.getElementById('student-name').value = session.studentName || '';
                document.getElementById('institute-type').value = session.instituteType || '';
                document.getElementById('student-institute').value = session.institute || '';
                document.getElementById('student-career').value = session.career || '';
                document.getElementById('semester-num').value = ''; // Limpiar semestre para el nuevo
                goToStep(2);
            } else {
                // Limpiar todo para nuevo registro desde cero
                document.getElementById('student-name').value = '';
                document.getElementById('institute-type').value = '';
                document.getElementById('student-institute').value = '';
                document.getElementById('student-career').value = '';
                document.getElementById('semester-num').value = '';
                goToStep(1);
            }
        }

        function showLogin(action) {
            loginAction = action;
            hideAllSteps();
            const el = document.getElementById('login-page');
            
            const btn = document.getElementById('login-btn');
            if(action === 'update') btn.innerText = 'Continuar';
            else btn.innerText = 'Ingresar';

            el.style.display = 'block';
            setTimeout(() => el.classList.add('active'), 10);
        }

        function hideAllSteps() {
            document.querySelectorAll('.step-container').forEach(el => {
                el.classList.remove('active');
                el.style.display = 'none';
            });
        }

        function attemptLogin() {
            const name = document.getElementById('login-name').value.trim();
            const inst = document.getElementById('login-institute').value.trim();
            const career = document.getElementById('login-career').value.trim();

            if(!name || !inst || !career) return alert("Complete todos los campos");

            const db = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            const found = db.find(u => 
                u.studentName.toLowerCase() === name.toLowerCase() && 
                u.institute.toLowerCase() === inst.toLowerCase() &&
                u.career.toLowerCase() === career.toLowerCase()
            );

            if(found) {
                localStorage.setItem('current_session', JSON.stringify(found));
                
                if (loginAction === 'update') {
                    // Cargar datos existentes en el formulario
                    document.getElementById('student-name').value = found.studentName;
                    document.getElementById('institute-type').value = found.instituteType;
                    document.getElementById('student-institute').value = found.institute;
                    document.getElementById('student-career').value = found.career;
                    document.getElementById('semester-num').value = found.semesterNum;
                    document.getElementById('semester-year').value = found.semesterYear;
                    goToStep(1);
                } else {
                    showWelcomeModal(found);
                }
            } else {
                alert("No se encontró un horario con esos datos.");
            }
        }

        // --- Navegación ---
        function goToStep(stepNum) {
            // Validaciones simples
            if(stepNum === 2) {
                if(!document.getElementById('student-name').value || !document.getElementById('student-institute').value || !document.getElementById('institute-type').value) return alert("Complete los campos");
            }
            
            if(stepNum === 3) {
                const semInput = document.getElementById('semester-num');
                if(!semInput.value || parseInt(semInput.value) < 1 || parseInt(semInput.value) > 10) {
                    alert("Ingrese un semestre válido (1-10).");
                    return;
                }
            }
            
            hideAllSteps();
            const next = document.getElementById(`step-${stepNum}`);
            next.style.display = 'block';
            setTimeout(() => next.classList.add('active'), 10);
        }

        function step2Back() {
            const session = localStorage.getItem('current_session');
            if(session) showWelcomeModal(JSON.parse(session));
            else goToStep(1);
        }

        function step3Back() {
            if(isEditing) showSchedulesList();
            else goToStep(2);
        }

        function validateSemester(input) {
            if (input.value === '0') input.value = '';
            if (input.value.length > 0) {
                const val = parseInt(input.value);
                if (val > 10) input.value = '10';
            }
        }

        function toggleDayStyle(input) {
            input.parentElement.classList.toggle('selected', input.checked);
        }

        // --- Generación de Formularios de Materias ---
        let selectedDays = [];

        function prepareSubjects() {
            const checkboxes = document.querySelectorAll('#step-3 input[type="checkbox"]:checked');
            if (checkboxes.length === 0) return alert("Seleccione al menos un día");

            selectedDays = Array.from(checkboxes).map(cb => cb.value);
            const container = document.getElementById('subjects-container');
            container.innerHTML = '';

            selectedDays.forEach(day => {
                const dayDiv = document.createElement('div');
                dayDiv.style.marginBottom = "20px";
                dayDiv.style.borderBottom = "1px solid #444";
                dayDiv.style.paddingBottom = "10px";
                
                // Preguntar número de materias
                dayDiv.innerHTML = `
                    <h3>${day}</h3>
                    <div class="form-group" style="width: 200px; margin: 0 auto;">
                        <label>Número de materias:</label>
                        <div style="display:flex; gap:5px;">
                            <input type="number" min="1" max="10" id="count-${day}" style="width: 70px; text-align: center;" oninput="validateSubjectCount(this, '${day}')">
                            <button id="btn-${day}" class="btn" style="margin:0; width:auto;" onclick="renderSubjectInputs('${day}')">Aceptar</button>
                        </div>
                    </div>
                    <div id="inputs-${day}"></div>
                `;
                container.appendChild(dayDiv);
            });

            // Si estamos editando, intentamos llenar los datos desde la sesión guardada
            if (isEditing) {
                const session = JSON.parse(localStorage.getItem('current_session'));
                if (session && session.schedule) {
                    selectedDays.forEach(day => {
                        const subjects = session.schedule[day];
                        if(subjects && subjects.length > 0) {
                            const countInput = document.getElementById(`count-${day}`);
                            if(countInput) {
                                countInput.value = subjects.length;
                                renderSubjectInputs(day); // Generar filas
                                
                                const rows = document.getElementById(`inputs-${day}`).querySelectorAll('.subject-row');
                                rows.forEach((row, idx) => {
                                    if(subjects[idx]) {
                                        row.querySelector('.sub-name').value = subjects[idx].name;
                                        row.querySelector('.sub-room').value = subjects[idx].room || '';
                                        row.querySelector('.sub-start').value = subjects[idx].start;
                                        row.querySelector('.sub-end').value = subjects[idx].end;
                                    }
                                });
                            }
                        }
                    });
                }
            }

            goToStep(4);
        }
        
        function validateSubjectCount(input, day) {
            if (input.value === '0') input.value = '';
            
            const btn = document.getElementById(`btn-${day}`);
            btn.disabled = false;
            btn.style.backgroundColor = '#333';
            btn.style.color = 'white';
            btn.style.cursor = 'pointer';
        }

        function renderSubjectInputs(day) {
            const count = document.getElementById(`count-${day}`).value;
            if(!count || count < 1) return;
            
            const container = document.getElementById(`inputs-${day}`);
            container.innerHTML = '';

            for (let i = 0; i < count; i++) {
                const row = document.createElement('div');
                row.className = 'subject-row';
                row.innerHTML = `
                    <div class="subject-inputs">
                        <div class="form-group">
                            <input type="text" class="sub-name" placeholder="Materia">
                        </div>
                        <div class="form-group">
                            <input type="text" class="sub-room" placeholder="Salón">
                        </div>
                        <div class="form-group">
                            <input type="text" readonly class="sub-start" placeholder="Inicio" onclick="openClock(this, true)">
                        </div>
                        <div class="form-group">
                            <input type="text" readonly class="sub-end" placeholder="Fin" onclick="openClock(this, false)">
                        </div>
                    </div>
                `;
                container.appendChild(row);
            }

            // Deshabilitar botón después de generar
            const btn = document.getElementById(`btn-${day}`);
            btn.disabled = true;
            btn.style.backgroundColor = '#555';
            btn.style.cursor = 'default';
            
            checkSubjectsCount();
        }

        function checkSubjectsCount() {
            const rows = document.querySelectorAll('.subject-row');
            const btn = document.getElementById('generate-btn');
            if (rows.length > 0) {
                btn.style.display = 'block';
            } else {
                btn.style.display = 'none';
            }
        }

        // --- Reloj Android Style ---
        let currentInput = null;
        let isStartMode = true; // true = seleccionando hora inicio (limitada), false = hora fin
        let tempHour = null;
        let tempMin = null;
        let mode = 'h'; // 'h' or 'm'
        let selectedAmPm = 'AM';

        function openClock(input, isStart) {
            currentInput = input;
            isStartMode = isStart; // Aunque el prompt dice "hora de inicio de este reloj sera desde las 7... maxima 1", aplicaré la restricción visual en la selección de horas.
            document.getElementById('clock-modal').style.display = 'flex';
            resetClock();
        }

        function closeClock() {
            document.getElementById('clock-modal').style.display = 'none';
        }

        function resetClock() {
            tempHour = null;
            tempMin = null;
            document.getElementById('clock-h').innerText = '--';
            document.getElementById('clock-m').innerText = '--';
            setAmPm('AM'); // Default
            document.getElementById('clock-ok-btn').style.display = 'none';
            switchClockMode('h');
        }

        function setAmPm(val) {
            selectedAmPm = val;
            document.getElementById('btn-am').style.color = val === 'AM' ? '#fff' : '#777';
            document.getElementById('btn-am').style.fontWeight = val === 'AM' ? 'bold' : 'normal';
            document.getElementById('btn-pm').style.color = val === 'PM' ? '#fff' : '#777';
            document.getElementById('btn-pm').style.fontWeight = val === 'PM' ? 'bold' : 'normal';
            if(tempHour !== null && tempMin !== null) document.getElementById('clock-ok-btn').style.display = 'inline-block';
        }

        function switchClockMode(m) {
            mode = m;
            const face = document.getElementById('clock-face');
            face.innerHTML = '';
            
            document.getElementById('clock-h').classList.toggle('active', m === 'h');
            document.getElementById('clock-m').classList.toggle('active', m === 'm');

            if (m === 'h') {
                // Renderizar Horas 1-12
                const radius = 80;
                
                for(let h=1; h<=12; h++) {
                    const el = document.createElement('div');
                    el.className = 'clock-number';
                    el.innerText = h;
                    
                    // 12 es -90deg. Cada hora son 30deg.
                    // Angulo = (h * 30) - 90
                    const angleDeg = (h * 30) - 90;

                    const angleRad = angleDeg * (Math.PI / 180);
                    const x = 100 + radius * Math.cos(angleRad) - 15;
                    const y = 100 + radius * Math.sin(angleRad) - 15;
                    
                    el.style.left = x + 'px';
                    el.style.top = y + 'px';
                    
                    el.onclick = () => selectHour(h);
                    face.appendChild(el);
                }
            } else {
                // Renderizar Minutos (00, 05, ... 55)
                const radius = 80;
                for (let i = 0; i < 60; i+=5) {
                    const el = document.createElement('div');
                    el.className = 'clock-number';
                    el.innerText = i < 10 ? '0' + i : i;
                    el.style.fontSize = '0.8rem';
                    
                    const angleRad = (i * 6 - 90) * (Math.PI / 180);
                    const x = 100 + radius * Math.cos(angleRad) - 15;
                    const y = 100 + radius * Math.sin(angleRad) - 15;
                    
                    el.style.left = x + 'px';
                    el.style.top = y + 'px';
                    
                    el.onclick = () => selectMin(i);
                    face.appendChild(el);
                }
            }
        }

        function selectHour(h) {
            tempHour = h;
            document.getElementById('clock-h').innerText = h;
            switchClockMode('m');
        }

        function selectMin(m) {
            tempMin = m;
            document.getElementById('clock-m').innerText = m < 10 ? '0' + m : m;
            document.getElementById('clock-ok-btn').style.display = 'inline-block';
        }

        function confirmTime() {
            // Formatear
            const minStr = tempMin < 10 ? '0' + tempMin : tempMin;
            currentInput.value = `${tempHour}:${minStr} ${selectedAmPm}`;
            closeClock();
        }

        // --- Generación del Horario (Visualización) ---
        function generateSchedule() {
            // 1. Recopilar datos del formulario
            const studentName = document.getElementById('student-name').value;
            const instituteType = document.getElementById('institute-type').value;
            const institute = document.getElementById('student-institute').value;
            const career = document.getElementById('student-career').value;
            const semesterNum = document.getElementById('semester-num').value;
            const semesterYear = document.getElementById('semester-year').value;

            const scheduleMap = {};
            
            selectedDays.forEach(day => {
                scheduleMap[day] = [];
                const inputsDiv = document.getElementById(`inputs-${day}`);
                if(!inputsDiv) return;
                const rows = inputsDiv.querySelectorAll('.subject-row');
                rows.forEach(row => {
                    const name = row.querySelector('.sub-name').value;
                    const room = row.querySelector('.sub-room').value;
                    const start = row.querySelector('.sub-start').value;
                    const end = row.querySelector('.sub-end').value;
                    if(name && start && end) {
                        scheduleMap[day].push({ name, room, start, end });
                    }
                });
            });

            const fullData = {
                studentName, instituteType, institute, career, semesterNum, semesterYear,
                days: selectedDays,
                schedule: scheduleMap
            };

            // 2. Guardar en LocalStorage
            saveToLocal(fullData);
            localStorage.setItem('current_session', JSON.stringify(fullData));

            // 3. Renderizar
            renderScheduleFromData(fullData, 'create');
        }

        function saveToLocal(data) {
            const db = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
            // Buscar si ya existe para actualizar, o agregar nuevo
            const idx = db.findIndex(u => 
                u.studentName === data.studentName && 
                u.institute === data.institute &&
                u.career === data.career
            );
            
            if(idx >= 0) db[idx] = data;
            else db.push(data);
            
            localStorage.setItem(STORAGE_KEY, JSON.stringify(db));
        }

        function renderScheduleFromData(data, mode = 'view') {
            // Renderizar Header
            const resContainer = document.getElementById('schedule-result');
            resContainer.innerHTML = '';
            
            const header = document.createElement('div');
            header.className = 'schedule-header';
            header.innerHTML = '<div class="time-col-header">Hora</div>';
            
            data.days.forEach(day => {
                const dh = document.createElement('div');
                dh.className = 'day-col-header';
                dh.innerText = day;
                header.appendChild(dh);
            });
            resContainer.appendChild(header);

            // Renderizar Cuerpo
            // Calcular hora mínima y máxima para ajustar altura
            let maxMinutes = 0;
            let minMinutes = 24 * 60;

            Object.values(data.schedule).forEach(daySubjects => {
                daySubjects.forEach(subj => {
                    const startMins = parseTime(subj.start);
                    const endMins = parseTime(subj.end);
                    if(endMins > maxMinutes) maxMinutes = endMins;
                    if(startMins < minMinutes) minMinutes = startMins;
                });
            });
            
            // Determinar hora inicial y final
            let startHour = 0;
            let endHour = 24;

            if (maxMinutes === 0) {
                startHour = 7;
                endHour = 18;
            } else {
                startHour = Math.floor(minMinutes / 60);
                endHour = Math.ceil(maxMinutes / 60);
            }

            if(startHour < 0) startHour = 0;
            if(endHour > 24) endHour = 24;
            if(endHour <= startHour) endHour = startHour + 1;

            const body = document.createElement('div');
            body.className = 'schedule-body';
            body.style.height = ((endHour - startHour) * 45) + 'px';
            
            // Columna de horas (startHour hasta endHour)
            const timeCol = document.createElement('div');
            timeCol.className = 'time-labels';
            for(let i=startHour; i<endHour; i++) {
                const label = document.createElement('div');
                label.className = 'time-label';
                label.style.top = ((i - startHour) * 45) + 'px'; // 45px por hora
                let displayH = i === 0 ? 12 : (i > 12 ? i - 12 : i);
                let suffix = i < 12 ? 'AM' : 'PM';
                if(i===12) suffix = 'PM';
                if(i===0) suffix = 'AM';
                label.innerText = `${displayH} ${suffix}`;
                timeCol.appendChild(label);
            }
            body.appendChild(timeCol);

            // Columnas de Días
            data.days.forEach(day => {
                const col = document.createElement('div');
                col.className = 'day-column';
                
                const daySubjects = data.schedule[day] || [];
                daySubjects.forEach(subj => {
                    // Calcular posición y altura
                    const startMins = parseTime(subj.start);
                    const endMins = parseTime(subj.end);
                    const duration = endMins - startMins;
                    
                    if (duration > 0) {
                        const block = document.createElement('div');
                        block.className = 'class-block';
                        block.style.top = ((startMins - (startHour * 60)) * 0.75) + 'px'; 
                        block.style.height = (duration * 0.75) + 'px';
                        block.innerHTML = `<strong style="display:block; margin-bottom:2px;">${subj.name}</strong><span style="display:block; margin-bottom:2px;">Salon: ${subj.room || ''}</span><span style="font-size:0.55rem;">${subj.start} - ${subj.end}</span>`;
                        col.appendChild(block);
                    }
                });
                body.appendChild(col);
            });

            resContainer.appendChild(body);

            // Llenar datos de cabecera
            document.getElementById('res-student').innerText = data.studentName;
            document.getElementById('res-details').innerText = 
                `${data.institute} | ${data.career} | Semestre: ${data.semesterNum} (${data.semesterYear})`;

            // Controlar visibilidad del botón Finalizar
            const btnFinish = document.getElementById('btn-finish');
            if (mode === 'create') btnFinish.style.display = 'block';
            else btnFinish.style.display = 'none';

            // Ir al paso 5 manualmente
            hideAllSteps();
            const step5 = document.getElementById('step-5');
            step5.style.display = 'block';
            setTimeout(() => step5.classList.add('active'), 10);
        }

        function parseTime(timeStr) {
            // Formato esperado: "7:00 AM" o "1:30 PM"
            const parts = timeStr.split(' ');
            const hm = parts[0].split(':');
            let h = parseInt(hm[0]);
            let m = parseInt(hm[1]);
            const ampm = parts[1];

            if (ampm === 'PM' && h !== 12) h += 12;
            if (ampm === 'AM' && h === 12) h = 0;

            return (h * 60) + m;
        }

        // --- PDF ---
        function downloadPDF() {
            const element = document.getElementById('schedule-to-print');
            
            const opt = {
                margin: [0.3, 0.3, 0.3, 0.3], // Márgenes: top, left, bottom, right
                filename: 'mi_horario.pdf',
                image: { type: 'jpeg', quality: 1 },
                html2canvas: { 
                    scale: 2, // Mejor calidad
                    useCORS: true,
                    scrollY: 0
                },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            
            // html2pdf tomará una "foto" del elemento y lo ajustará al PDF
            html2pdf().set(opt).from(element).save();
        }

        function downloadPNG() {
            const element = document.getElementById('schedule-to-print');
            
            // Usamos html2canvas (que viene incluido en el bundle de html2pdf)
            html2canvas(element, {
                scale: 2, // Mayor resolución
                useCORS: true,
                backgroundColor: '#ffffff' // Asegurar fondo blanco
            }).then(canvas => {
                // Crear un enlace temporal para descargar
                const link = document.createElement('a');
                link.download = 'mi_horario.png';
                link.href = canvas.toDataURL('image/png');
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            });
        }

        function finishSchedule() {
            backToSession();
        }

        // Iniciar
        checkAvailability();

    </script>
</body>
</html>